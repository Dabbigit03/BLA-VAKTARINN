<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLA VÖRÐURINN</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#141825;--text:#e7e9ef;--muted:#8f9bb3;--line:rgba(255,255,255,.08);
      --accent:#6ea8fe;--accent-2:#a78bfa;--ok:#2dd4bf;--danger:#ff6b6b;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial}
    .app{min-height:100vh;display:grid;grid-template-rows:auto 1fr auto}

    /* Header */
    header{position:sticky;top:0;z-index:40;background:var(--panel);border-bottom:1px solid var(--line);box-shadow:0 2px 12px rgba(0,0,0,.25)}
    .headrow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px}
    h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(20px,2.6vw,28px)}
    .user-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eaefff;color:#0b1020;font-weight:600}
    .user-pill.link{background:transparent;color:var(--text);border:1px solid var(--line);cursor:pointer}
    .user-pill.link:hover{background:rgba(255,255,255,.08)}

    /* Layout */
    main{padding:12px 12px 80px}
    .panel{display:none}
    .panel.active{display:block}

    /* Cards */
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:12px;color:var(--text)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .big{font-size:32px;font-weight:800}
    .muted{color:var(--muted)}
    .btns{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
    @media(min-width:900px){.btns{grid-template-columns:repeat(3,minmax(0,1fr))}}

    /* Buttons */
    .btn{border:1px solid var(--line);background:#0f1320;cursor:pointer;color:var(--text);padding:12px;border-radius:12px;font-weight:700}
    .btn:hover{outline:1px solid rgba(110,168,254,.4)}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,.6);color:#fff;font-weight:700;border-radius:12px;padding:12px}
    .btn-ghost:hover{background:rgba(255,255,255,.06);border-color:#fff}
    .btn-primary{background:linear-gradient(180deg,#6ea8fe,#4e89ff);border:none;color:white;border-radius:12px;padding:12px}
    .btn-danger{background:#2a0f14;border:1px solid rgba(255,107,107,.3);color:#ffc1c1;border-radius:12px;padding:12px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .warn{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(255,107,107,.4);background:rgba(255,107,107,.08);color:#ffc1c1}

    /* Lists */
    .list{margin-top:10px;max-height:260px;overflow:auto}
    .item{display:grid;grid-template-columns:1fr auto;gap:6px;padding:10px 0;border-bottom:1px dashed var(--line)}
    .pill{padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid var(--line)}
    .good{color:var(--ok);border-color:rgba(45,212,191,.3);background:rgba(45,212,191,.08)}
    .bad{color:var(--danger);border-color:rgba(255,107,107,.4);background:rgba(255,107,107,.08)}

    /* Inputs */
    .field{display:grid;gap:6px}
    .field input,.field select,.field textarea{background:#0f1320;border:1px solid var(--line);border-radius:10px;padding:10px;color:var(--text)}
    .field input::placeholder,.field textarea::placeholder{color:var(--muted);opacity:1}
    .field input[disabled]{color:var(--muted)}
    select, option{color:var(--text);background:#0f1320}

    /* Profile */
    .screen{position:relative}
    .screen-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .actions-row{display:flex;gap:8px;align-items:center;margin-top:12px}
    .gap{flex:1}
    .right{display:flex;gap:8px}
    .avatar{width:64px;height:64px;border-radius:12px;background:#0f1320;border:1px solid var(--line)}

    /* Bottom nav */
    .tabbar{position:sticky;bottom:0;z-index:30;background:rgba(12,14,20,.72);backdrop-filter:blur(12px);border-top:1px solid var(--line)}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr)}
    .tab{appearance:none;background:none;border:0;color:var(--muted);padding:10px 6px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
    .tab.active{color:var(--text)}
    .ico{font-size:20px}

    /* Session visibility */
    #sessionContent{display:none}
    body.session-active #sessionContent{display:block}
    body.session-active #sessionSetup{display:none}
    .end-session{position:sticky;bottom:12px;z-index:2;background:var(--panel);box-shadow:0 -6px 18px rgba(0,0,0,.25)}

    /* Desktop polish */
    @media(min-width:900px){
      body{display:flex;justify-content:center}
      .app{width:min(980px,100%)}
      main{padding:24px 24px 90px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="headrow">
        <h1>BLA VÖRÐURINN</h1>
        <span id="userPill" class="user-pill" hidden>Log in</span>
      </div>
    </header>

    <main>
      <!-- HOME (empty) -->
      <section id="homePanel" class="panel active">
        <div class="card"><h3 style="margin:0">Your posts</h3><div id="homeFeed" class="list" style="margin-top:8px"></div></div>
      </section>      

      <!-- SEARCH -->
      <section id="searchPanel" class="panel">
        <div class="card">
          <div class="field" style="position:sticky; top:0; z-index:1; background:var(--panel);">
            <label for="searchInput">Search users</label>
            <input type="text" id="searchInput" placeholder="Type a username…" />
          </div>
          <div class="list" id="searchResults" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- SESSION -->
      <section id="sessionPanel" class="panel">
        <!-- Session setup (visible BEFORE a session) -->
        <div id="sessionSetup" class="card">
          <div class="muted">Choose how to set your session</div>
          <div class="btns">
            <button class="btn" id="chooseDefault" type="button">Use default settings</button>
            <button class="btn" id="chooseCustom" type="button">Custom settings</button>
          </div>
          <div id="customFields" style="display:none; margin-top:12px">
            <div class="row">
              <div class="field" style="flex:1"><label for="customMaxUnits">Max units</label><input type="number" id="customMaxUnits" min="1" step="0.1" placeholder="e.g. 6.5" /></div>
            </div>
          </div>
          <div class="actions-row">
            <div class="muted" id="sessionSetupPreview">Pick an option above.</div>
            <div class="gap"></div>
            <button class="btn-primary" id="startSessionBtn" type="button">Start session</button>
          </div>
        </div>

        <!-- Actual session content (hidden UNTIL session starts) -->
        <div id="sessionContent">
          <div class="card">
            <div class="row">
              <div>
                <div class="muted">Current units</div>
                <div class="big" id="currentUnits">0.0</div>
                <div class="muted" id="lastUpdated"></div>
              </div>
              <div>
                <div class="muted">Remaining capacity</div>
                <div class="big" id="remainingUnits">6.5</div>
                <div class="muted">until your limit</div>
              </div>
            </div>
            <div class="toolbar">
              <button class="btn-ghost" id="undoBtn" type="button" title="Undo last">↩ Undo last</button>
              <button class="btn-danger" id="resetBtn" type="button" title="Clear drinks">✕ Reset all</button>
              <button class="btn" id="newSessionBtn" type="button" title="Start a new session">＋ New session</button>
            </div>
          </div>

          <!-- Add drink -->
          <section class="card">
            <div class="muted">Add a drink</div>
            <div class="btns" id="quickBtns"></div>
            <div class="toolbar">
              <button class="btn-ghost" id="customBtn" type="button">➕ Custom drink</button>
              <div class="gap"></div>
            </div>
            <div id="warning" class="warn" style="display:none"></div>
          </section>

          <!-- Next times -->
          <section class="card">
            <div class="muted">When can you have the next one?</div>
            <div class="list" id="nextTimes"></div>
          </section>

          <!-- Active drinks -->
          <section class="card">
            <div class="muted">Active drinks</div>
            <div class="list" id="activeList"></div>
          </section>

          <!-- End session -->
          <section class="card end-session">
            <div class="actions-row">
              <div class="muted">Done drinking?</div>
              <div class="gap"></div>
              <button class="btn-danger" id="endSessionBtn" type="button">End session</button>
            </div>
          </section>
        </div> <!-- /#sessionContent -->
      </section>

      <!-- PROFILE -->
      <section id="profilePanel" class="panel">
        <div class="card screen">
          <header class="screen-header"><h2>Profile</h2></header>

          <!-- PUBLIC VIEW -->
          <section id="screenPublic">
  <div class="card" id="adminPanelCard" style="display:none; margin-bottom:12px">
    <div class="row" style="align-items:center">
      <h3 style="margin:0">Admin: All Profiles</h3>
      <div class="gap"></div>
      <div class="right"><button class="btn-ghost" id="adminRefresh" type="button">Refresh</button></div>
    </div>
    <div class="list" id="adminUsersList" style="margin-top:8px"></div>
  </div>

            <div class="row" style="align-items:flex-start;gap:16px">
              <div class="avatar"></div>
              <div style="flex:1">
                <div class="muted">Username</div>
                <div id="pubUsername" style="font-weight:800;font-size:18px">—</div>
                <div class="muted" style="margin-top:6px">Gender: <span id="pubGender">—</span></div>
              </div>
              <div>
                <button class="btn" id="openSettingsPanel" type="button">⚙ Settings</button>
                <button class="btn" id="openSessionsPanelProfile" type="button">🗂 Sessions</button>
              </div>
            </div>
<div class="card" id="profileSessionsCard" style="margin-top:12px">
  <div class="row" style="align-items:center">
    <h3 style="margin:0">Sessions</h3>
    <div class="gap"></div>
    <div class="right">
      <button class="btn-ghost" id="sessFilterAll" type="button" aria-pressed="true">All</button>
      <button class="btn-ghost" id="sessFilterPosts" type="button" aria-pressed="false">Posts</button>
    </div>
  </div>
  <div class="list" id="profileSessions" style="margin-top:8px"></div>
</div>
</section>
<!-- LOGIN VIEW -->
          <section id="screenLogin" hidden>
            <div class="field">
              <label for="usernameInput">Username</label>
              <input type="text" id="usernameInput" placeholder="Enter username" />
            </div>
            <div class="field" style="margin-top:8px;">
              <label for="passwordInput">Password</label>
              <input type="password" id="passwordInput" placeholder="Password" />
            </div>
            <div class="actions-row">
              <button class="btn-ghost" id="userCancelLogin" type="button">Cancel</button>
              <div class="gap"></div>
              <div class="right">
                <button class="btn-ghost" id="openRegister" type="button">Register</button>
                <button class="btn-primary" id="userLogin" type="button">Continue</button>
              </div>
            </div>
          </section>

          <!-- EDIT VIEW (own settings) -->
          <section id="screenEdit" hidden>
            <div class="field">
              <label for="currentUserLabel">Current user</label>
              <input id="currentUserLabel" disabled />
            </div>

            <div class="field" style="margin-top:8px;">
              <label for="newUsernameInput">Display name</label>
              <input type="text" id="newUsernameInput" placeholder="e.g. Alex" />
            </div>

            <div class="field" style="margin-top:8px;">
              <label for="userBioInput">Bio</label>
              <textarea id="userBioInput" rows="3" placeholder="Say something about you..."></textarea>
            </div>

            <div class="row" style="margin-top:14px;">
              <div class="field" style="flex:1">
                <label for="heightInput">Height (cm)</label>
                <input type="number" id="heightInput" min="1" step="1" />
              </div>
              <div class="field" style="flex:1">
                <label for="weightInput">Weight (kg)</label>
                <input type="number" id="weightInput" min="1" step="0.1" />
              </div>
            </div>

            <div class="field" style="margin-top:8px;">
              <label for="genderSelect">Sex / body model</label>
              <select id="genderSelect">
                <option value="karl">Male</option>
                <option value="kona">Female</option>
                <option value="annad">Other / prefer not to say</option>
              </select>
            </div>

            <div class="row" style="margin-top:14px;">
              <div class="field" style="flex:1">
                <label for="defaultMaxUnits">Default max units</label>
                <input type="number" id="defaultMaxUnits" min="1" step="0.1" placeholder="e.g. 6.5" />
                <div class="muted"><small>Recommended: <span id="recUnits">—</span> <button class="btn-ghost" id="useRecUnits" type="button">Use</button></small></div>
              </div>
            </div>

            <div class="actions-row">
              <button class="btn-ghost" id="userLogout" type="button">Log out</button>
              <div class="gap"></div>
              <button class="btn-primary" id="userSave" type="button">Save</button>
            </div>
          </section>
        </div>
      </section>
    </main>

    <!-- Bottom nav -->
    <nav class="tabbar">
      <div class="tabs">
        <button class="tab active" data-tab="homePanel" aria-label="Home"><div class="ico">🏠</div><div>Home</div></button>
        <button class="tab" data-tab="searchPanel" aria-label="Search"><div class="ico">🔍</div><div>Search</div></button>
        <button class="tab" data-tab="sessionPanel" aria-label="New session"><div class="ico">🍺</div><div>Session</div></button>
        <button class="tab" data-tab="profilePanel" aria-label="Profile"><div class="ico">👤</div><div>Profile</div></button>
      </div>
    </nav>
  </div>

  <!-- Custom drink modal -->
  <template id="customModalTpl">
    <div class="card" style="position:fixed;inset:20px;max-width:520px;margin:auto;z-index:50;background:var(--panel);box-shadow:0 10px 40px rgba(0,0,0,.4)">
      <h3 style="margin-top:0">Custom drink</h3>
      <div class="field"><label for="customVolumeInput">Volume (ml)</label><input type="number" id="customVolumeInput" min="1" step="1" placeholder="150" /></div>
      <div class="field" style="margin-top:8px"><label for="customAbvInput">ABV (%)</label><input type="number" id="customAbvInput" min="0" step="0.1" placeholder="12" /></div>
      <div class="muted" style="margin-top:8px">≈ <span id="customUnitsPreview">—</span> units</div>
      <div class="actions-row">
        <button class="btn-ghost" id="customCancel">Cancel</button>
        <div class="gap"></div>
        <button class="btn-primary" id="customAdd" disabled>Add</button>
      </div>
    </div>
  </template>

  <!-- Settings modal (small) -->
  <template id="settingsModalTpl">
    <div class="card" style="position:fixed;inset:20px;max-width:520px;margin:auto;z-index:50;background:var(--panel);box-shadow:0 10px 40px rgba(0,0,0,.4)">
      <h3 style="margin-top:0">Session settings</h3>
      <div class="row">
        <div class="field" style="flex:1"><label for="maxUnits">Max units</label><input id="maxUnits" type="number" min="1" step="0.1" /></div>
      </div>
      <div class="actions-row">
        <button id="closeSettings" class="btn-ghost">Close</button>
        <div class="gap"></div>
        <button id="saveSettings" class="btn-primary">Save</button>
      </div>
    </div>
  </template>

  <!-- Sessions manager modal -->
<template id="sessionsModalTpl">
  <div class="card" style="position:fixed;inset:20px;max-width:640px;margin:auto;z-index:60;background:var(--panel);box-shadow:0 10px 40px rgba(0,0,0,.4)">
    <h3 style="margin-top:0">Your sessions</h3>
    <div id="sessMgrList" class="list" style="margin-top:8px"></div>
    <div class="actions-row">
      <div class="muted"><small>Tip: “Remove from profile” keeps the session in this list but hides it from your public feed.</small></div>
      <div class="gap"></div>
      <button class="btn-ghost" id="sessMgrClose" type="button">Close</button>
    </div>
  </div>
</template>



    <!-- Session summary (shown when ending a session) -->
  <template id="sessionSummaryTpl">
    <div class="card" style="position:fixed;inset:20px;max-width:560px;margin:auto;z-index:60;background:var(--panel);box-shadow:0 10px 40px rgba(0,0,0,.4)">
      <h3 style="margin-top:0">Session summary</h3>
      <div class="row">
        <div class="field" style="flex:1">
          <div class="muted">Total units</div>
          <div id="sumUnits" class="big">0.0</div>
        </div>
        <div class="field" style="flex:1">
          <div class="muted">Duration</div>
          <div id="sumDuration" class="big">—</div>
        </div>
      </div>
      <div class="field" style="margin-top:12px">
        <label for="sumDesc">Add a description (optional)</label>
        <textarea id="sumDesc" rows="3" maxlength="280" placeholder="How was it? (max 280 chars)"></textarea>
        <div class="muted"><small><span id="sumCount">0</span>/280</small></div>
      </div>
      <div class="actions-row">
        <button class="btn-ghost" id="sumSaveOnly" type="button">Save without posting</button>
        <div class="gap"></div>
        <button class="btn-ghost" id="sumCancel" type="button">Cancel</button>
        <button class="btn-primary" id="sumPost" type="button">Post to profile</button>
      </div>
    </div>
  </template>


  <script>
    // ==== Core logic & constants ====
    const UNIT_SCALE = 10;
    const HARD_LIMIT = 100; // 10.0 units max in tenths (legacy)
    const DEFAULT_SETTINGS = { maxUnits: 6.5 };

    const DRINKS = [
      { name: '🥃 20% shot',   u10: 4 },
      { name: '🥃 40% shot',   u10: 7 },
      { name: '🍷 Wine glass', u10: 8 },
      { name: '🍸 Cocktail',   u10: 8 },
      { name: '🍺 330 ml beer',u10: 7 },
      { name: '🍺 500 ml beer',u10: 10 },
    ];

    const time24 = new Intl.DateTimeFormat('is-IS', { hour: '2-digit', minute: '2-digit', hour12: false, hourCycle: 'h23' });
    const fmtTime = (t) => time24.format(new Date(t));
    const now = () => Date.now();

    // === Storage (keeping your keys) ===
    function loadDrinksRaw(){ try{ const raw = localStorage.getItem('drinks.v1'); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr)?arr:[] } catch{ return [] } }
    function saveDrinks(arr){ try{ localStorage.setItem('drinks.v1', JSON.stringify(arr)); }catch(e){} }
    function loadSettings(){
    try{
      const raw = localStorage.getItem('settings.v1');
      const base = { ...DEFAULT_SETTINGS };
      if(!raw) return base;
      const obj = JSON.parse(raw);
      if (Number.isFinite(obj.maxUnits)) base.maxUnits = obj.maxUnits;
      return base;
    } catch { return { ...DEFAULT_SETTINGS } }
  }
  function saveSettings(s){
    try{
      const out = { maxUnits: Number.isFinite(s.maxUnits) ? s.maxUnits : DEFAULT_SETTINGS.maxUnits };
      localStorage.setItem('settings.v1', JSON.stringify(out));
    }catch(e){}
  }

    function loadProfiles(){ try{ const raw = localStorage.getItem('profiles.v1'); return raw?JSON.parse(raw):{} } catch{ return {} } }
    function saveProfiles(p){ try{ localStorage.setItem('profiles.v1', JSON.stringify(p)); }catch(e){} }
    function getCurrentUser(){ try{ return localStorage.getItem('currentUser.v1') || '' } catch{ return '' } }
    function setCurrentUser(u){ try{ localStorage.setItem('currentUser.v1', u || '') } catch{} }

    // === Session activation ===
    function isSessionActive(){ try{ return localStorage.getItem('session.active.v1') === '1'; }catch{return false} }
    function setSessionActive(v){ try{ localStorage.setItem('session.active.v1', v ? '1':'0'); }catch{} }

    // Keeps the Session screen in sync with session state
    function loadSessionView(){
  const active = isSessionActive();
  const setup   = document.getElementById('sessionSetup');
  const content = document.getElementById('sessionContent');
  if(!setup || !content) return;
  document.body.classList.toggle('session-active', active);
  setup.style.display   = active ? 'none' : '';
  content.style.display = active ? '' : 'none';

  // --- Lock when not logged in ---
  const loggedIn = !!getCurrentUser();
  const prev = document.getElementById('sessionSetupPreview');
  const cmu = document.getElementById('customMaxUnits');
  const chooseDefault = document.getElementById('chooseDefault');
  const chooseCustom = document.getElementById('chooseCustom');
  const startBtn = document.getElementById('startSessionBtn');

  if(!active){
    if(!loggedIn){
      if(prev) prev.textContent = 'Log in to start a session.';
      if(cmu){ cmu.value = ''; cmu.disabled = true; }
      if(chooseDefault){ chooseDefault.disabled = true; }
      if(chooseCustom){ chooseCustom.disabled = true; }
      if(startBtn){ startBtn.disabled = true; startBtn.title = 'Log in first'; }
      return;
    }
    // When logged in, enable controls and show defaults
    if(cmu){ cmu.disabled = false; }
    if(chooseDefault){ chooseDefault.disabled = false; }
    if(chooseCustom){ chooseCustom.disabled = false; }
    if(startBtn){ startBtn.disabled = false; startBtn.title = ''; }
    const d = computeDefaultSettings();
    const s = loadSettings();
    if(prev) prev.textContent = `Default: ${d.maxUnits.toFixed ? d.maxUnits.toFixed(1) : d.maxUnits} units`;
    if(cmu){ cmu.value = s.maxUnits ?? d.maxUnits; }
  }
}

    // === Recommendations (formulas ported) ===
    const UNIT_G = 19.7;                      // grams ethanol per unit
    const COOLDOWN_NORMALIZE = 0.8;           // ~60 min/unit feel
    const REC_BAC_TARGET = 0.0017;            // 0.17%
    const REC_COEFF = REC_BAC_TARGET / UNIT_G;
    const ELIM_PER_L_PER_H = 0.2;             // g/h per liter TBW

    function calculateTBW(heightCm, weightKg, gender){
      if(!(heightCm>0 && weightKg>0)) return null;
      const h = Number(heightCm)||0, w = Number(weightKg)||0;
      if(gender==='karl') return 2.447 + 0.1074*h + 0.3362*w;
      if(gender==='kona') return -2.097 + 0.1069*h + 0.2466*w;
      const m = 2.447 + 0.1074*h + 0.3362*w;
      const f = -2.097 + 0.1069*h + 0.2466*w;
      return (m+f)/2;
    }
    function widmarkR(g){ if(g==='karl') return 0.68; if(g==='kona') return 0.55; return 0.615; }

    function recommendCooldownMin(heightCm, weightKg, gender){
      const hOk = Number.isFinite(heightCm) && heightCm > 0;
      const wOk = Number.isFinite(weightKg) && weightKg > 0;
      if(hOk && wOk){
        const tbwL = calculateTBW(heightCm, weightKg, gender || 'annad');
        const elim_g_per_h = ELIM_PER_L_PER_H * tbwL;
        if(elim_g_per_h > 0){
          let minutes = (60 * UNIT_G) / elim_g_per_h;
          minutes *= COOLDOWN_NORMALIZE;
          minutes = Math.max(60, Math.min(180, minutes));
          return Math.round(minutes / 5) * 5;
        }
      }
      let rec = 60 * Math.pow(80 / (weightKg || 80), 0.3);
      if(gender === 'kona') rec += 5;
      rec = Math.max(45, Math.min(90, rec));
      return Math.round(rec / 5) * 5;
    }
    function recommendMaxUnits(heightCm, weightKg, gender){
      const wOk = Number.isFinite(weightKg) && weightKg > 0;
      const hOk = Number.isFinite(heightCm) && heightCm > 0;
      let units;
      if(wOk && hOk){
        const tbwL = calculateTBW(heightCm, weightKg, gender || 'annad');
        units = REC_COEFF * tbwL * 1000;
      } else if (wOk){
        const r = widmarkR(gender || 'annad');
        units = REC_COEFF * r * (weightKg * 1000);
      } else {
        units = 5.5;
      }
      const clamped = Math.max(3.0, Math.min(9.0, units));
      return Math.round(clamped * 2) / 2;
    }

    function computeDefaultSettings(){
    const u = getCurrentUser();
    const profiles = loadProfiles();
    const p = u ? (profiles[u] || {}) : {};

    if (Number.isFinite(p.defaultMaxUnits)) {
      return { maxUnits: p.defaultMaxUnits };
    }

    const h = p.heightCm, w = p.weightKg, g = p.gender || 'annad';
    const maxUnits = Number.isFinite(w) ? recommendMaxUnits(h, w, g) : DEFAULT_SETTINGS.maxUnits;
    return { maxUnits };
  }


    // === Derived helpers ===
function eliminationRateUnitsPerHour(){
  // Prefer TBW-based elimination: 0.2 g/h per liter TBW, convert to units/h
  const profiles = loadProfiles();
  const u = getCurrentUser();
  const p = u ? (profiles[u]||{}) : {};
  const h = Number(p.heightCm)||0, w = Number(p.weightKg)||0, g = p.gender || 'annad';
  if(h>0 && w>0 && typeof calculateTBW === 'function'){
    const tbwL = calculateTBW(h, w, g);
    if(tbwL && tbwL>0){
      const elim_g_per_h = 0.2 * tbwL;
      return elim_g_per_h / UNIT_G; // units/hour
    }
  }
// Fallback: generic average ~1 unit/hour
return 1.0;

}
    function prune(drinks){ return Array.isArray(drinks)?drinks:[]; }
    function addDrink(units10){ const drinks = loadDrinksRaw(); drinks.push({ t: now(), u: units10 }); saveDrinks(drinks); render(); flashWarnings(); }
    function undoLast(){ const drinks = loadDrinksRaw(); drinks.pop(); saveDrinks(drinks); render(); }
    function newSession(){ saveDrinks([]); applyUserDefaultsToSettings(); render(); }
    function resetAll(){ if(!confirm('Clear all drinks?')) return; saveDrinks([]); render(); }

    const fmtUnits = (u10) => (u10/UNIT_SCALE).toFixed(1);
    function humanDuration(ms){ if(ms<=0) return 'now'; const s=Math.ceil(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; const parts=[]; if(h) parts.push(`${h} h`); if(m) parts.push(`${m} min`); if(!h && !m) parts.push(`${sec} s`); return parts.join(' '); }

    function unitsFromVolumeAbv(volumeMl, abvPercent){ if(!Number.isFinite(volumeMl)||volumeMl<=0) return 0; if(!Number.isFinite(abvPercent)||abvPercent<=0) return 0; const pureMl = volumeMl * (abvPercent/100); return pureMl / 25; }

    function applyUserDefaultsToSettings(){
      const u = getCurrentUser(); if(!u) return;
      const profiles = loadProfiles(); const p = profiles[u] || {};
      const s = loadSettings();
      if(Number.isFinite(p.defaultMaxUnits)) s.maxUnits = p.defaultMaxUnits;
      saveSettings(s);
    }


    // --- Sessions storage ---
    function loadSessionsMap(){ try{ return JSON.parse(localStorage.getItem('sessions.v1')||'{}'); } catch { return {}; } }
    function saveSessionsMap(m){ try{ localStorage.setItem('sessions.v1', JSON.stringify(m)); } catch{} }
    function loadUserSessions(u){ const m=loadSessionsMap(); return Array.isArray(m[u])?m[u]:[]; }
    function pushUserSession(u, rec){
      const m = loadSessionsMap();
      m[u] = Array.isArray(m[u]) ? m[u] : [];
      m[u].unshift(rec);
      saveSessionsMap(m);
    }
    function updateSessionPosted(user, id, posted){
      const m = loadSessionsMap();
      const arr = Array.isArray(m[user]) ? m[user] : [];
      const i = arr.findIndex(s => s.id === id);
      if(i >= 0){ arr[i] = { ...arr[i], posted: !!posted }; m[user] = arr; saveSessionsMap(m); }
    }
    function deleteUserSession(user, id){
      const m = loadSessionsMap();
      const arr = Array.isArray(m[user]) ? m[user] : [];
      m[user] = arr.filter(s => s.id !== id);
      saveSessionsMap(m);
    }


    // --- Session meta (when the session started, etc.) ---
    function loadSessionMeta(){ try{ return JSON.parse(localStorage.getItem('session.meta.v1')||'{}'); } catch { return {}; } }
    function saveSessionMeta(meta){ try{ localStorage.setItem('session.meta.v1', JSON.stringify(meta||{})); } catch{} }
    function clearSessionMeta(){ try{ localStorage.removeItem('session.meta.v1'); } catch{} }



    // === Render ===
    const els = {
      currentUnits: document.getElementById('currentUnits'),
      remainingUnits: document.getElementById('remainingUnits'),
      lastUpdated: document.getElementById('lastUpdated'),
      nextTimes: document.getElementById('nextTimes'),
      activeList: document.getElementById('activeList'),
      quickBtns: document.getElementById('quickBtns'),
      // session controls
      undoBtn: document.getElementById('undoBtn'),
      resetBtn: document.getElementById('resetBtn'),
      newSessionBtn: document.getElementById('newSessionBtn'),
      warning: document.getElementById('warning'),
      // header pill
      userPill: document.getElementById('userPill'),
      // profile
      screenPublic: document.getElementById('screenPublic'),
      screenLogin: document.getElementById('screenLogin'),
      screenEdit: document.getElementById('screenEdit'),
      usernameInput: document.getElementById('usernameInput'),
      passwordInput: document.getElementById('passwordInput'),
      currentUserLabel: document.getElementById('currentUserLabel'),
      newUsernameInput: document.getElementById('newUsernameInput'),
      userBioInput: document.getElementById('userBioInput'),
      heightInput: document.getElementById('heightInput'),
      weightInput: document.getElementById('weightInput'),
      genderSelect: document.getElementById('genderSelect'),
      defaultMaxUnits: document.getElementById('defaultMaxUnits'),
      userLogout: document.getElementById('userLogout'),
      userSave: document.getElementById('userSave'),
      pubUsername: document.getElementById('pubUsername'),
      pubGender: document.getElementById('pubGender'),
      openSettingsPanel: document.getElementById('openSettingsPanel'),
      // search
      searchInput: document.getElementById('searchInput'),
      searchResults: document.getElementById('searchResults'),
      // session setup
      chooseDefault: document.getElementById('chooseDefault'),
      chooseCustom: document.getElementById('chooseCustom'),
      customFields: document.getElementById('customFields'),
      customMaxUnits: document.getElementById('customMaxUnits'),
      startSessionBtn: document.getElementById('startSessionBtn'),
      endSessionBtn: document.getElementById('endSessionBtn'),
      openSessionsPanelProfile: document.getElementById('openSessionsPanelProfile'),
    };

    function computeState(){
  const s = loadSettings();
  const limit10 = Math.round(s.maxUnits * UNIT_SCALE);
  const t = now();
  const R = eliminationRateUnitsPerHour(); // units/hour
  const drinks = loadDrinksRaw();
  const active = drinks
    .map(d => {
      const elapsedH = Math.max(0, (t - d.t) / 3600000);
      const remainingUnits = Math.max(0, (d.u/UNIT_SCALE) - R*elapsedH);
      const remToZeroH = remainingUnits>0 ? remainingUnits / R : 0;
      return { ...d, uLeft10: Math.round(remainingUnits*UNIT_SCALE), remMs: Math.round(remToZeroH*3600000) };
    })
    .filter(d => d.uLeft10 > 0)
    .sort((a,b)=>a.remMs-b.remMs);
  const current = active.reduce((sum,d)=>sum + d.uLeft10, 0);
  const remaining = Math.max(0, limit10 - current);
  return { t, active, current, remaining, limit10, settings:s, R };
}


  let _sessFilter = 'all'; // 'all' | 'posted'

  function renderProfileSessions(){
    const u = getCurrentUser();
    const box = document.getElementById('profileSessions'); if(!box) return;
    const btnAll = document.getElementById('sessFilterAll');
    const btnPosts = document.getElementById('sessFilterPosts');

    if(btnAll && btnPosts){
      btnAll.setAttribute('aria-pressed', _sessFilter==='all' ? 'true' : 'false');
      btnPosts.setAttribute('aria-pressed', _sessFilter==='posted' ? 'true' : 'false');
    }

    if(!u){ box.innerHTML = '<div class="muted">Log in to view your sessions.</div>'; return; }

    let items = loadUserSessions(u);
    if(_sessFilter==='posted') items = items.filter(s=>s.posted);

    if(!items.length){ box.innerHTML = '<div class="muted">No sessions yet.</div>'; return; }

    box.innerHTML = items.map(s=>{
      const units = (s.totalUnits10/UNIT_SCALE).toFixed(1);
      const dur = humanDuration(s.durationMs);
      const when = new Date(s.endedAt).toLocaleString();
      const tag = s.posted ? '<span class="pill">Posted</span>' : '<span class="pill">Saved</span>';
      return `
        <div class="item">
          <div>
            <div><strong>${units} units</strong> · ${dur}</div>
            <div class="muted"><small>${when}</small></div>
            ${s.description ? `<div style="margin-top:4px">${escapeHtml(s.description)}</div>` : ''}
          </div>
          <div>${tag}</div>
        </div>
      `;
    }).join('');
  }

  // attach filter buttons once
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='sessFilterAll'){ _sessFilter='all'; renderProfileSessions(); }
    if(e.target && e.target.id==='sessFilterPosts'){ _sessFilter='posted'; renderProfileSessions(); }
  });



    function timeUntilCapacity(need10, state){
  const R = eliminationRateUnitsPerHour(); // units/hour, constant
  if(!(R>0)) return Infinity;
  const deficitUnits = Math.max(0, (state.current + need10 - state.limit10) / UNIT_SCALE);
  if(deficitUnits===0) return 0;
  const hours = deficitUnits / R;
  return Math.max(0, Math.round(hours * 3600000));
}

  function flashWarnings(){
    if (!isSessionActive()) {
      els.warning.style.display = 'none';
      els.warning.textContent = '';
      return;
    }
    const state = computeState();
    let msg = '';
    if (state.current >= state.limit10) msg = 'You are at your limit.';
    else if (state.limit10 - state.current <= 5) msg = 'You are close to your limit.';
    els.warning.style.display = msg ? 'block' : 'none';
    els.warning.textContent = msg;
  }



      function renderHomeFeed(){
      const wrap = document.getElementById('homeFeed'); if(!wrap) return;
      const u = getCurrentUser(); wrap.innerHTML = '';
      if(!u){ wrap.innerHTML = '<div class="muted">Log in to see your posts.</div>'; return; }

      const items = loadUserSessions(u).filter(s=>s.posted);
      if(!items.length){ wrap.innerHTML = '<div class="muted">No posts yet.</div>'; return; }

      wrap.innerHTML = items.map(s=>{
        const units = (s.totalUnits10/UNIT_SCALE).toFixed(1);
        const dur = humanDuration(s.durationMs);
        const desc = s.description ? `<div style="margin-top:4px">${escapeHtml(s.description)}</div>` : '';
        const when = new Date(s.endedAt).toLocaleString();
        return `
          <div class="item">
            <div>
              <div><strong>${units} units</strong> · ${dur}</div>
              <div class="muted"><small>${when}</small></div>
              ${desc}
            </div>
            <div class="pill">Posted</div>
          </div>
        `;
      }).join('');
    }

    // tiny helper to avoid HTML injection from description
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }


    function render(){
      const state = computeState();
      els.currentUnits.textContent = fmtUnits(state.current);
      els.remainingUnits.textContent = fmtUnits(state.remaining);
      els.lastUpdated.textContent = state.active.length ? `Last: ${fmtTime(state.active[state.active.length-1].t)}` : '';

      // build quick buttons
      els.quickBtns.innerHTML = DRINKS.map(d => `<button class=\"btn\" data-units=\"${d.u10}\">${d.name} (${fmtUnits(d.u10)})</button>`).join('');

      // next times
      const items = DRINKS.map(d => {
        const t = timeUntilCapacity(d.u10, state);
        return `<div class="item"><div>${d.name}</div><div class="pill ${t? 'bad':'good'}">${t?('in '+humanDuration(t)):'now'}</div></div>`;
      }).join('');
      els.nextTimes.innerHTML = items;

      // active list
      if(!state.active.length){ els.activeList.innerHTML = '<div class="muted">No active drinks.</div>'; }
      else {
        els.activeList.innerHTML = state.active.map((d)=>`<div class=\"item\"><div>${fmtUnits(d.uLeft10)} units · added ${fmtTime(d.t)}</div><div class=\"pill\">to zero in ${humanDuration(d.remMs)}</div></div>`).join('');
      }

      updateUserPill();
      bindDynamicButtons();
      flashWarnings();
    }

    function updateUserPill(){
      const u = getCurrentUser();
      els.userPill.onclick = null;
      els.userPill.classList.remove('link');
      if(u){
        els.userPill.removeAttribute('hidden');
        els.userPill.textContent = `User: ${u}`;
      } else {
        els.userPill.removeAttribute('hidden');
        els.userPill.textContent = 'Log in';
        els.userPill.classList.add('link');
        els.userPill.onclick = () => {
          document.querySelector('[data-tab="profilePanel"]').click();
          els.screenLogin.hidden = false;
          els.screenEdit.hidden = true;
          els.screenPublic.hidden = true;
          setTimeout(()=> els.usernameInput.focus(), 0);
        };
      }
    }

    // dynamic button handlers for drink buttons
    function bindDynamicButtons(){
  document.querySelectorAll('#quickBtns .btn').forEach(b=>{
    b.addEventListener('click', ()=> {
      if(!getCurrentUser()){
        alert('Log in to modify a session.');
        document.querySelector('[data-tab="profilePanel"]').click();
        els.screenPublic.hidden = true; els.screenEdit.hidden = true; els.screenLogin.hidden = false;
        setTimeout(()=> els.usernameInput && els.usernameInput.focus(), 0);
        return;
      }
      if(!isSessionActive()){
        alert('Start a session first.');
        document.querySelector('[data-tab="sessionPanel"]').click();
        return;
      }
      addDrink(parseInt(b.getAttribute('data-units'),10));
    });
  });
}

    // === Modals ===
    function openCustomModal(){
      const tpl = document.getElementById('customModalTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      document.body.appendChild(node);
      const vol = node.querySelector('#customVolumeInput');
      const abv = node.querySelector('#customAbvInput');
      const prev= node.querySelector('#customUnitsPreview');
      const add = node.querySelector('#customAdd');
      function update(){ const u = unitsFromVolumeAbv(parseFloat(vol.value), parseFloat(abv.value)); prev.textContent = (u||0).toFixed(1); add.disabled = !(u>0); }
      vol.addEventListener('input', update); abv.addEventListener('input', update);
      node.querySelector('#customCancel').onclick = ()=> node.remove();
      node.querySelector('#customAdd').onclick = ()=>{ const u = unitsFromVolumeAbv(parseFloat(vol.value), parseFloat(abv.value)); if(u>0) addDrink(Math.round(u*UNIT_SCALE)); node.remove(); };
    }

      function openSessionSummary(){
      // Build modal
      const tpl = document.getElementById('sessionSummaryTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      document.body.appendChild(node);

      // Fill numbers
      const drinks = loadDrinksRaw(); // [{t,u}]
      const total10 = drinks.reduce((s,d)=> s + (Number(d.u)||0), 0);
      const meta = loadSessionMeta();
      const startedAt = Number(meta.startedAt) || (drinks[0]?.t) || Date.now();
      const endedAt = Date.now();
      const durMs = Math.max(0, endedAt - startedAt);

      node.querySelector('#sumUnits').textContent = (total10/UNIT_SCALE).toFixed(1);
      node.querySelector('#sumDuration').textContent = humanDuration(durMs);

      // Description counter
      const ta = node.querySelector('#sumDesc');
      const cnt = node.querySelector('#sumCount');
      ta.addEventListener('input', ()=>{ cnt.textContent = ta.value.length; });

      // Finalize (end + clear + save record + UI reset)
      function finalize(posted){
        const u = getCurrentUser() || 'anon';
        const rec = {
          id: `${startedAt}-${endedAt}`,
          startedAt, endedAt,
          durationMs: durMs,
          totalUnits10: total10,
          drinks: drinks.slice(0),
          posted: !!posted,
          description: (ta.value||'').trim().slice(0,280),
          maxUnitsAtStart: Number(meta.maxUnitsAtStart)||null
        };
        pushUserSession(u, rec);

        // end session & clear
        setSessionActive(false);
        document.body.classList.remove('session-active');
        saveDrinks([]);
        clearSessionMeta();

        // UI: back to pre-session screen
        loadSessionView();
        render();
        renderHomeFeed();       // refresh Home with posted items (if any)
        openProfile();
    renderAdminPanel();          // so profile shows posts/sessions immediately
        node.remove();
      }

      node.querySelector('#sumPost').onclick = ()=> finalize(true);
      node.querySelector('#sumSaveOnly').onclick = ()=> finalize(false);
      node.querySelector('#sumCancel').onclick = ()=> {
      node.remove();
    };
    }

    function openSessionsPanel(){
    const u = getCurrentUser();
    const tpl = document.getElementById('sessionsModalTpl');
    const node = tpl.content.firstElementChild.cloneNode(true);
    document.body.appendChild(node);

    const list = node.querySelector('#sessMgrList');
    const closeBtn = node.querySelector('#sessMgrClose');

    function renderList(){
      if(!u){ list.innerHTML = '<div class="muted">Log in to view your sessions.</div>'; return; }
      const items = loadUserSessions(u);
      if(!items.length){ list.innerHTML = '<div class="muted">No sessions yet.</div>'; return; }

      list.innerHTML = items.map(s=>{
        const units = (s.totalUnits10/UNIT_SCALE).toFixed(1);
        const dur = humanDuration(s.durationMs);
        const when = new Date(s.endedAt).toLocaleString();
        const tag = s.posted ? '<span class="pill good">Posted</span>' : '<span class="pill">Saved</span>';
        // action buttons: Unpost if currently posted; always allow Delete
        const unpostBtn = s.posted ? `<button class="btn-ghost" data-unpost="${s.id}">Remove from profile</button>` : '';
        return `
          <div class="item">
            <div>
              <div><strong>${units} units</strong> · ${dur}</div>
              <div class="muted"><small>${when}</small></div>
              ${s.description ? `<div style="margin-top:4px">${escapeHtml(s.description)}</div>` : ''}
            </div>
            <div class="right" style="display:flex;gap:6px;align-items:center">
              ${tag}
              ${unpostBtn}
              <button class="btn-danger" data-delete="${s.id}">Delete</button>
            </div>
          </div>
        `;
      }).join('');

      // bind actions
      list.querySelectorAll('[data-unpost]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-unpost');
          updateSessionPosted(u, id, false);
          renderList();
          renderHomeFeed();
          renderProfileSessions();
        });
      });
      list.querySelectorAll('[data-delete]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-delete');
          if(confirm('Delete this session permanently?')){
            deleteUserSession(u, id);
            renderList();
            renderHomeFeed();
            renderProfileSessions();
          }
        });
      });
    }

    closeBtn.onclick = ()=> node.remove();
    renderList();
  }


    function openSettingsModal(){
    const tpl = document.getElementById('settingsModalTpl');
    const node = tpl.content.firstElementChild.cloneNode(true);
    document.body.appendChild(node);
    const s = loadSettings();
    const maxUnits = node.querySelector('#maxUnits');
    maxUnits.value = s.maxUnits;
    node.querySelector('#closeSettings').onclick = ()=> node.remove();
    node.querySelector('#saveSettings').onclick = ()=>{
      const v = { maxUnits: parseFloat(maxUnits.value) || DEFAULT_SETTINGS.maxUnits };
      saveSettings(v); node.remove(); render();
    };
  }


    function renderSearchResults(){
    if(!els.searchResults) return;

    const q = (els.searchInput && els.searchInput.value ? els.searchInput.value : '')
      .trim()
      .replace(/^@+/, '')
      .toLowerCase();

    // NEW: require at least 3 characters before showing any users
    if (q.replace(/\s+/g,'').length < 1) {
      els.searchResults.innerHTML = '';
      return;
    }

    const profiles = loadProfiles();
    const users = Object.keys(profiles);
    const filtered = users.filter(u => {
      const uname = String(u).toLowerCase();
      const dname = String((profiles[u] && profiles[u].name) || '').toLowerCase();
      return uname.includes(q) || dname.includes(q);
    });

    if(filtered.length === 0){ els.searchResults.innerHTML = '<div class="muted">No users found.</div>'; return; }
    els.searchResults.innerHTML = filtered.map(u => {
      const p = profiles[u] || {}; const name = p.name ? ` · ${p.name}` : '';
      return `<div class="item"><div>@${u}${name}</div><div><button class="btn-ghost" data-open-user="${u}">Open</button></div></div>`;
    }).join('');

    els.searchResults.querySelectorAll('[data-open-user]').forEach(btn => {
      btn.addEventListener('click', () => {
        const u = btn.getAttribute('data-open-user');
        document.querySelector('[data-tab="profilePanel"]').click();
        openProfile(u); // view-only
      });
    });
  }


    // === Profile views ===
    function openProfile(viewUser){
      // public view by default
      els.screenPublic.hidden = false;
      els.screenLogin.hidden = true;
      els.screenEdit.hidden = true;

      const profiles = loadProfiles();
      const current = getCurrentUser();
      const who = viewUser || current;

      // show Settings button ONLY on own profile
      if (els.openSettingsPanel){
        const isOwn = current && (!viewUser || viewUser === current);
        els.openSettingsPanel.style.display = isOwn ? '' : 'none';
      }

      if (who){
        const p = profiles[who] || {};
        els.pubUsername.textContent = '@' + who + (p.name ? ` · ${p.name}` : '');
        const gMap = { karl: 'Male', kona: 'Female', annad: 'Other' };
        els.pubGender.textContent = gMap[p.gender] || '—';
      } else {
        els.pubUsername.textContent = 'Not logged in';
        els.pubGender.textContent  = '—';
      }
      renderProfileSessions();

      if (els.openSessionsPanelProfile){
      const isOwn = current && (!viewUser || viewUser === current);
      els.openSessionsPanelProfile.style.display = isOwn ? '' : 'none';
    }

    }

    function doLogin(){
  const uRaw = (els.usernameInput.value||'').trim();
  const pRaw = (els.passwordInput && els.passwordInput.value) ? String(els.passwordInput.value) : '';
  if(!uRaw){ alert('Enter a username.'); return; }
  if(!pRaw){ alert('Enter your password.'); return; }

  const profiles = loadProfiles();
  const keys = Object.keys(profiles);
  const matchKey = keys.find(k => k.toLowerCase() === uRaw.toLowerCase());
  if(!matchKey){
    alert('No such user. Please register first.');
    return;
  }

  const prof = profiles[matchKey] || {};

  // Enforce that every user must have a password and it must match
  if(!Object.prototype.hasOwnProperty.call(prof, 'password') || typeof prof.password !== 'string'){
    alert('This user has no password set yet. Please Register to set a password for this username.');
    return;
  }
  if(prof.password !== pRaw){
    alert('Incorrect password.');
    return;
  }

  setCurrentUser(matchKey);
  updateUserPill();
  if (typeof applyUserDefaultsToSettings === 'function') applyUserDefaultsToSettings();
  if (typeof updateRecommendations === 'function') updateRecommendations();
  openProfile();
    renderAdminPanel(); // back to public view
  render();
}
    function doLogout(){ setCurrentUser(''); openProfile();
    renderAdminPanel(); updateUserPill(); render(); }

    function saveProfile(){
      const u = getCurrentUser(); if(!u) return;
      const profiles = loadProfiles(); const p = profiles[u]||{};
      p.name = (els.newUsernameInput.value||'').trim();
      p.bio = (els.userBioInput.value||'').trim();
      p.heightCm = parseInt(els.heightInput.value,10)||null;
      p.weightKg = parseFloat(els.weightInput.value)||null;
      p.gender = els.genderSelect.value||'annad';
      p.defaultMaxUnits = parseFloat(els.defaultMaxUnits.value)||null;
      profiles[u]=p; saveProfiles(profiles);
      applyUserDefaultsToSettings(); render();
    }

    function openSettingsView(){
      const u = getCurrentUser();
      if(u){
        // go to edit
        els.screenPublic.hidden = true; els.screenLogin.hidden = true; els.screenEdit.hidden = false;
        // prefill
        const profiles = loadProfiles(); const p = profiles[u] || {};
        els.currentUserLabel.value = u;
        els.newUsernameInput.value = p.name || '';
        els.userBioInput.value = p.bio || '';
        els.heightInput.value = p.heightCm || '';
        els.weightInput.value = p.weightKg || '';
        els.genderSelect.value = p.gender || 'annad';
        els.defaultMaxUnits.value = p.defaultMaxUnits || '';
        updateRecommendations?.();
    ensureAdminProfile();
      } else {
        // go to login
        els.screenPublic.hidden = true; els.screenEdit.hidden = true; els.screenLogin.hidden = false; setTimeout(()=> els.usernameInput.focus(), 0);
      }
    }

    // === Search/init bindings ===
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.getAttribute('data-tab');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='profilePanel'){ openProfile();
    renderAdminPanel(); updateRecommendations?.();
    ensureAdminProfile(); }
        if(id==='searchPanel'){ setTimeout(()=>{ els.searchInput?.focus(); renderSearchResults(); }, 0); }
        if(id==='sessionPanel'){ loadSessionView(); }
      });
    });

    // Make search responsive to typing and Enter key
    if (els.searchInput){
      // Live filter as you type
      els.searchInput.addEventListener('input', ()=>{
        renderSearchResults();
      });
      // Pressing Enter: open exact match if available, otherwise first filtered result
      els.searchInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          const qlc = (els.searchInput && els.searchInput.value ? els.searchInput.value : '')
          .trim()
          .replace(/^@+/, '')
          .toLowerCase();

        // block opening profiles if fewer than 3 characters
        if (qlc.replace(/\s+/g,'').length < 1) {
          renderSearchResults();
          return;
        }

        els.searchInput.addEventListener('change', renderSearchResults);
        const profiles = loadProfiles();
        const users = Object.keys(profiles);

        const exactUsername = users.find(u => String(u).toLowerCase() === qlc);
        const exactDisplay  = users.find(u => String((profiles[u] && profiles[u].name) || '').toLowerCase() === qlc);

        const filtered = qlc
          ? users.filter(u => {
              const uname = String(u).toLowerCase();
              const dname = String((profiles[u] && profiles[u].name) || '').toLowerCase();
              return uname.includes(qlc) || dname.includes(qlc);
            })
          : users;


          if (exactUsername || exactDisplay || filtered.length){
            const openUser = exactUsername || exactDisplay || filtered[0];
            document.querySelector('[data-tab="profilePanel"]').click();
            openProfile(openUser); // view-only, do not sign in
          } else {
            renderSearchResults();
          }

        }
      });
    }

    // Static button listeners
    // Session core
    els.undoBtn.onclick = ()=>{ if(!getCurrentUser()||!isSessionActive()){ alert('No active session. Log in and start one.'); return; } undoLast(); };
    els.resetBtn.onclick = ()=>{ if(!getCurrentUser()||!isSessionActive()){ alert('No active session. Log in and start one.'); return; } resetAll(); };
    els.newSessionBtn.onclick = ()=>{ if(!getCurrentUser()){ alert('Please log in to start a session.'); document.querySelector('[data-tab="profilePanel"]').click(); els.screenPublic.hidden = true; els.screenEdit.hidden = true; els.screenLogin.hidden = false; setTimeout(()=> els.usernameInput && els.usernameInput.focus(), 0); return; } newSession(); };
    document.getElementById('customBtn').onclick = openCustomModal;

    // Session setup
    if(els.chooseDefault){ els.chooseDefault.onclick = ()=>{ const d = computeDefaultSettings(); els.customFields.style.display='none'; document.getElementById('sessionSetupPreview').textContent = `Using default: ${d.maxUnits.toFixed?d.maxUnits.toFixed(1):d.maxUnits} units`; els.startSessionBtn.dataset.mode = 'default'; } }
    if(els.chooseCustom){ els.chooseCustom.onclick = ()=>{ els.customFields.style.display=''; document.getElementById('sessionSetupPreview').textContent = 'Set your custom values below.'; els.startSessionBtn.dataset.mode = 'custom'; } }
    if(els.startSessionBtn){ els.startSessionBtn.onclick = ()=>{  
      
      // Require login before starting a session
      if(!getCurrentUser()){
        alert('Please log in to start a session.');
        document.querySelector('[data-tab="profilePanel"]').click();
        els.screenPublic.hidden = true; els.screenEdit.hidden = true; els.screenLogin.hidden = false;
        setTimeout(()=> els.usernameInput && els.usernameInput.focus(), 0);
        return;
      }
const mode = els.startSessionBtn.dataset.mode || 'default';
      let cfg;
      if (mode === 'custom') {
        const max = parseFloat(els.customMaxUnits.value);
        cfg = { maxUnits: Number.isFinite(max) ? max : DEFAULT_SETTINGS.maxUnits };
      } else {
        cfg = computeDefaultSettings();
      }
      saveSettings(cfg);

      // actually start the session 👇
      saveSessionMeta({ startedAt: Date.now(), maxUnitsAtStart: cfg.maxUnits });
      setSessionActive(true);
      loadSessionView();
      render();
    }; }

    if (els.endSessionBtn) { els.endSessionBtn.onclick = openSessionSummary; }

    // Profile actions
    document.getElementById('userLogin').onclick = doLogin;
    if(els.passwordInput){ els.passwordInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doLogin(); } }); }
    document.getElementById('userCancelLogin').onclick = ()=>{ els.screenPublic.hidden = false; els.screenLogin.hidden = true; els.screenEdit.hidden = true; };
document.getElementById('openRegister').onclick = () => {
  const uRaw = (els.usernameInput.value || '').trim();
  const pRaw = (els.passwordInput && els.passwordInput.value) ? String(els.passwordInput.value) : '';
  if (!uRaw) { alert('Enter a username to register.'); return; }
  if (!pRaw) { alert('Choose a password.'); return; }

  const profiles = loadProfiles();
  const keys = Object.keys(profiles);
  const exists = keys.some(k => k.toLowerCase() === uRaw.toLowerCase());
  if (exists) { alert('That username is already taken. Try logging in.'); return; }

  // Create and store the profile
  profiles[uRaw] = {
    name: '', bio: '',
    heightCm: null, weightKg: null, gender: 'annad',
    defaultMaxUnits: null,
    createdAt: Date.now(),
    password: pRaw
  };
  saveProfiles(profiles);

  // Immediately sign in and show the app
  setCurrentUser(uRaw);
  updateUserPill();
  if (typeof applyUserDefaultsToSettings === 'function') applyUserDefaultsToSettings();

  // Show public profile (same as successful login)
  els.screenPublic.hidden = false;
  els.screenLogin.hidden  = true;
  els.screenEdit.hidden   = true;

  // clear inputs
  if (els.passwordInput) els.passwordInput.value = '';
  if (els.usernameInput) els.usernameInput.value = '';

  openProfile();
    renderAdminPanel();         // populate public view
  render();              // refresh session UI
  renderHomeFeed();      // refresh home posts
  renderProfileSessions();
};


    els.userLogout.onclick = ()=>{ doLogout(); openProfile();
    renderAdminPanel(); };
    els.userSave.onclick = ()=>{
    saveProfile();
    // Close the settings (edit view) and show the public profile view
    els.screenEdit.hidden = true;
    els.screenLogin.hidden = true;
    els.screenPublic.hidden = false;

    // Keep things fresh
    openProfile();
    renderAdminPanel();        // repopulate public view
    updateUserPill();     // refresh header pill if name changed
    render();             // refresh session-related UI if needed
  };

    if(els.openSettingsPanel){ els.openSettingsPanel.onclick = openSettingsView; }
    if(els.openSessionsPanelProfile){ els.openSessionsPanelProfile.onclick = openSessionsPanel; }


    // Recommendations helpers
    function updateRecommendations(){
    const uEl = document.getElementById('recUnits'); if(!uEl) return;
    const h = parseFloat(els.heightInput.value);
    const w = parseFloat(els.weightInput.value);
    const g = els.genderSelect.value || 'annad';
    const haveW = Number.isFinite(w)&&w>0;
    const haveH = Number.isFinite(h)&&h>0;

    if(haveW){
      const ru = recommendMaxUnits(haveH?h:undefined, w, g);
      uEl.textContent = ru.toFixed(1);
      const btnU = document.getElementById('useRecUnits');
      if(btnU){ btnU.disabled=false; btnU.onclick=()=>{ els.defaultMaxUnits.value = ru.toFixed(1); }; }
    } else {
      uEl.textContent='—';
      const btnU=document.getElementById('useRecUnits');
      if(btnU) btnU.disabled=true;
    }
  }

    ;['heightInput','weightInput','genderSelect'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', updateRecommendations); });

    // === Admin bootstrap & tools ===
function ensureAdminProfile(){
  const profiles = loadProfiles();
  if(!profiles['MASTERBLA']){
    profiles['MASTERBLA'] = {
      name: 'MASTERBLA', bio: 'Administrator',
      heightCm: null, weightKg: null, gender: 'annad',
      defaultMaxUnits: null,
      createdAt: Date.now(),
      password: 'IAMTHEMASTERBLA',
      role: 'admin'
    };
    saveProfiles(profiles);
  } else {
    profiles['MASTERBLA'].password = 'IAMTHEMASTERBLA';
    profiles['MASTERBLA'].role = 'admin';
    saveProfiles(profiles);
  }
}
function isAdminUser(u){ return String(u).toUpperCase() === 'MASTERBLA'; }
function renderAdminPanel(){
  const wrap = document.getElementById('adminPanelCard');
  const list = document.getElementById('adminUsersList');
  if(!wrap || !list) return;
  const current = getCurrentUser();
  if(!isAdminUser(current)){ wrap.style.display = 'none'; list.innerHTML=''; return; }
  const profiles = loadProfiles();
  const users = Object.keys(profiles).sort((a,b)=>a.localeCompare(b));
  wrap.style.display = '';
  if(!users.length){ list.innerHTML = '<div class="muted">No users found.</div>'; return; }
  list.innerHTML = users.map(u=>{
    const p = profiles[u]||{};
    const name = p.name ? ` · ${p.name}` : '';
    const role = p.role ? `<span class="pill">${p.role}</span>` : '';
    const disabled = (u==='MASTERBLA') ? 'disabled' : '';
    return `<div class="item">
      <div>@${u}${name} ${role}</div>
      <div class="right" style="display:flex;gap:6px">
        <button class="btn-ghost" data-admin-open="${u}">Open</button>
        <button class="btn-danger" data-admin-del="${u}" ${disabled}>Delete</button>
      </div>
    </div>`;
  }).join('');
}
function adminDeleteUser(u){
  if(u==='MASTERBLA'){ alert('Cannot delete the admin user.'); return; }
  if(!confirm(`Delete @${u} and all their sessions? This cannot be undone.`)) return;
  const profiles = loadProfiles();
  delete profiles[u];
  saveProfiles(profiles);
  try{
    const m = JSON.parse(localStorage.getItem('sessions.v1')||'{}');
    if(m && m[u]){ delete m[u]; localStorage.setItem('sessions.v1', JSON.stringify(m)); }
  }catch{}
  if(getCurrentUser() === u){ setCurrentUser(''); }
  renderAdminPanel(); renderProfileSessions(); renderHomeFeed(); updateUserPill(); openProfile();
    renderAdminPanel();
}
document.addEventListener('click', (e)=>{
  const t = e.target;
  if(!t) return;
  if(t.id === 'adminRefresh'){ renderAdminPanel(); }
  if(t.hasAttribute && t.hasAttribute('data-admin-del')){ adminDeleteUser(t.getAttribute('data-admin-del')); }
  if(t.hasAttribute && t.hasAttribute('data-admin-open')){ const u=t.getAttribute('data-admin-open'); document.querySelector('[data-tab=\"profilePanel\"]').click(); openProfile(u); }
});

    // Boot
    updateRecommendations?.();
    ensureAdminProfile();
    loadSessionView();
    openProfile();
    renderAdminPanel();
    render();
    renderHomeFeed();
    if(els.searchResults){ renderSearchResults(); }
  </script>
</body>
</html>
