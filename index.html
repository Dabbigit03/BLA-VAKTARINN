<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLA V√ñR√êURINN</title>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #151a2d;
      --muted: #8f9bb3;
      --text: #e7e9ef;
      --accent: #6ea8fe;
      --accent-2: #a78bfa;
      --danger: #ff6b6b;
      --ok: #2dd4bf;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #1b2040, #0c0f1c 60%, #0a0c18);
      color: var(--text);
      display: grid; place-items: start center; padding: 32px; gap: 24px;
    }
    .app {
      width: min(920px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    header { padding: 16px 20px; background: linear-gradient(120deg, rgba(110,168,254,.15), rgba(167,139,250,.12)); border-bottom: 1px solid rgba(255,255,255,.08); }
    .headrow { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1 { margin: 0; font-size: clamp(20px, 2.6vw, 30px); letter-spacing: .2px; }
    .sub { color: var(--muted); margin-top: 6px; font-size: 14px; }

    .grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 16px; padding: 20px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    /* right side: pill + menu button */
    .menu-wrap { display: flex; align-items: center; gap: 8px; }

    .user-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px;
      background: #eaefff; color: #0b1020; font-weight: 700; font-size: 12px;
      border: 1px solid rgba(255,255,255,.35); cursor: pointer;
      box-shadow: 0 4px 12px rgba(110,168,254,.18), inset 0 1px 0 rgba(255,255,255,.5);
    }
    .user-pill::before { content: "üë§"; }

    .card {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 16px; }

    .big {
      font-size: clamp(32px, 6vw, 56px);
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: -0.5px;
    }
    .muted { color: var(--muted); font-size: 14px; }

    .btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .btn {
      appearance: none; border: none; cursor: pointer;
      padding: 14px 14px; border-radius: 14px; font-weight: 700; font-size: 16px;
      color: #0b1020; background: #eaefff; transition: transform .04s ease, filter .15s ease, background .2s;
      box-shadow: 0 6px 18px rgba(110,168,254,.25), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .beer { background: #c7f9cc; }
    .shot { background: #fef08a; }
    .cocktail { background: #fbcfe8; }
    .wine { background: #e9d5ff; }

    .ghost {
      background: transparent; color: var(--muted); border: 1px dashed rgba(255,255,255,.18);
      padding: 6px 10px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 12px;
    }
    .ghost:hover { border-style: solid; color: #cfd5e6; }

    .warn { background: rgba(255,107,107,.12); border: 1px solid rgba(255,255,255,.35); color: #ffd7d7; padding: 12px 14px; border-radius: 12px; margin-top: 12px; }

    .list { margin-top: 10px; max-height: 260px; overflow: auto;}
    .item { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .pill { padding: 4px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; border: 1px solid rgba(255,255,255,.12); }
    .good { color: var(--ok); border-color: rgba(45,212,191,.3); background: rgba(45,212,191,.08); }
    .bad  { color: var(--danger); border-color: rgba(255,107,107,.4); background: rgba(255,107,107,.08); }

    .toolbar { display:flex; gap:8px; flex-wrap: wrap; margin-top:12px; }
    .sr-only { position:absolute; left:-10000px; width:1px; height:1px; overflow:hidden; }

    /* Menu (dropdown) */
    .menu-btn { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.25); padding: 8px 10px; border-radius: 10px; cursor: pointer; }
    .menu { position: absolute; right: 0; top: 42px; background: var(--panel); border:1px solid rgba(255,255,255,.15); border-radius: 12px; box-shadow: var(--shadow); min-width: 220px; padding: 6px; }
    .menu-item { width: 100%; text-align: left; background: transparent; color: var(--text); border: none; padding: 10px 12px; border-radius: 10px; cursor:pointer; }
    .menu-item:hover { background: rgba(255,255,255,.06); }

    /* Modal + hidden */
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: grid; place-items: center; }
    [hidden] { display: none !important; }
    .modal { width: min(520px, 92vw); background: var(--panel); border:1px solid rgba(255,255,255,.15); border-radius: 16px; padding: 18px; box-shadow: var(--shadow); }
    .modal h2 { margin: 0 0 12px 0; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field { display:flex; flex-direction: column; gap:6px; }
    .field label { font-size: 14px; color: var(--muted); }
    .field input, .field select {
      padding: 10px 12px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: #0e1426; color: var(--text);
    }
    .muted small { opacity: .95; }

    .modal-actions { display:flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
    .btn-primary { background: #c7d2fe; color: #0b1020; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }

    /* Modal ghost buttons: previous, chunkier look */
    .modal .btn-ghost {
      background: transparent; color: var(--muted);
      border: 1px dashed rgba(255,255,255,.25);
      padding: 10px 14px; border-radius: 10px;
      font-weight: 700; font-size: 14px; cursor: pointer;
    }
    .modal .btn-ghost:hover { color: #cfd5e6; border-style: solid; }

    /* --- Mobile polish --- */
    @media (max-width: 480px) {
      html, body { overflow-x: hidden; }
      body { padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom)); }
      .app { width: 100%; border-radius: 12px; }
      header { padding: 12px 14px; }
      .headrow { align-items: flex-start; gap: 8px; flex-wrap: wrap; }
      h1 { font-size: 20px; }
      .sub { font-size: 12px; line-height: 1.3; white-space: normal; word-break: break-word; }
      .grid { padding: 12px; gap: 12px; }
      .card { padding: 14px; }
      .row { gap: 10px; }
      .big { font-size: clamp(24px, 9vw, 36px); }

      /* Buttons: 3 columns on phones to fit 6 neatly */
      .btns { grid-template-columns: repeat(3, 1fr); gap: 10px; }
      .btn { padding: 12px; font-size: 15px; border-radius: 12px; }

      .list { max-height: 34vh; -webkit-overflow-scrolling: touch; }
      .item { padding: 8px 0; }

      /* Let JS handle exact menu position; just keep sensible width */
      .menu { min-width: min(92vw, 360px); max-width: 92vw; }
      .modal { width: 94vw; }
      .form-row { grid-template-columns: 1fr; }
      .field input { font-size: 16px; } /* avoid iOS zoom-on-focus */
    }

    @media (min-width: 520px) and (max-width: 720px) {
      .btns { grid-template-columns: repeat(3, 1fr); }
    }
    @media (min-width: 900px) {
      .btns { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 480px) {
      .app > header { position: sticky; top: 0; z-index: 10; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="√Åfengiseiningar ‚Äî stillanlegar stillingar">
    <header>
      <div class="headrow">
        <div>
          <h1>BLA V√ñR√êURINN</h1>
          <div class="sub" id="subline">
            20% skot 0.4 ¬∑ 40% skot 0.7 ¬∑ v√≠nglas/kokteill 0.8 ¬∑ bj√≥r 330ml 0.7 ¬∑ bj√≥r 500ml 1.0 ¬∑ H√°mark: 6.5 ¬∑ Bi√∞t√≠mi: 60 m√≠n
          </div>
        </div>
        <div class="menu-wrap">
          <span class="user-pill" id="userPill" hidden title="S√Ωna notandastillingar"></span>
          <button class="menu-btn" id="menuBtn">‚ò∞ Valmynd</button>
          <div class="menu" id="menu" hidden>
            <button class="menu-item" id="openSettings">Stillingar</button>
            <button class="menu-item" id="newSession">N√Ω lota</button>
            <button class="menu-item" id="userSettings">Notandastillingar</button>
            <button class="menu-item" id="openDisclaimer">Fyrirvari</button>
          </div>          
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Totals / Remaining -->
      <section class="card" aria-live="polite">
        <div class="row">
          <div>
            <div class="muted">N√∫verandi einingar</div>
            <div class="big" id="currentUnits">0.0</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Einingar eftir</div>
            <div class="big" id="remainingUnits">6.5</div>
          </div>
        </div>
        <div class="toolbar">
          <button class="ghost" id="undoBtn" title="Afturkalla s√≠√∞asta drykk">‚Ü∂ fjarl√¶gja s√≠√∞asta</button>
          <button class="ghost" id="resetBtn" title="Hreinsa alla drykki">‚úï Endurstilla</button>
          <span class="muted" id="lastUpdated" aria-live="off"></span>
        </div>
      </section>

      <!-- Add drink -->
      <section class="card">
        <div class="muted">B√¶ta vi√∞ drykk</div>
        <div class="btns">
          <button class="btn shot"     data-units="4">ü•É 20% skot (0.4)</button>
          <button class="btn shot"     data-units="7">ü•É 40% skot (0.7)</button>
          <button class="btn wine"     data-units="8">üç∑ V√≠nglas (0.8)</button>
          <button class="btn cocktail" data-units="8">üç∏ Kokteill (0.8)</button>
          <button class="btn beer"     data-units="7">üç∫ 330 ml bj√≥r (0.7)</button>
          <button class="btn beer"     data-units="10">üç∫ 500 ml bj√≥r (1.0)</button>
        </div>


	<div class="toolbar" style="margin-top:8px;">
  	<button class="ghost" id="customBtn" type="button">‚ûï S√©rsni√∞inn drykkur</button>
	</div>


        <div id="warning" class="warn" style="display:none"></div>
      </section>

      <!-- Next available times -->
      <section class="card">
        <div class="muted">Hven√¶r er n√¶sti?</div>
        <div class="list" id="nextTimes"></div>
      </section>

      <!-- Active drinks list -->
      <section class="card">
        <div class="muted">Virkir drykkir:</div>
        <div class="list" id="activeList"></div>
      </section>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="backdrop" id="settingsBackdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <h2 id="settingsTitle">Stillingar</h2>
      <div class="form-row">
        <div class="field">
          <label for="maxUnitsInput">H√°marks einingar</label>
          <input type="number" id="maxUnitsInput" step="0.1" min="0" value="6.5">
        </div>
        <div class="field">
          <label for="cooldownMinutesInput">Bi√∞t√≠mi (m√≠n√∫tur)</label>
          <input type="number" id="cooldownMinutesInput" step="1" min="1" value="60">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" id="cancelSettings" type="button">H√¶tta vi√∞</button>
        <button class="btn-primary" id="saveSettings" type="button">Vista</button>
      </div>
    </div>
  </div>


<!-- Custom Drink Modal -->
<div class="backdrop" id="customBackdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="customTitle">
    <h2 id="customTitle">S√©rsni√∞inn drykkur</h2>

    <div class="form-row">
      <div class="field">
        <label for="customVolumeInput">Magn (ml)</label>
        <input type="number" id="customVolumeInput" min="1" step="1" placeholder="t.d. 150" />
      </div>
      <div class="field">
        <label for="customAbvInput">Styrkur (%)</label>
        <input type="number" id="customAbvInput" min="0" max="100" step="0.1" placeholder="t.d. 12.5" />
      </div>
    </div>

    <div class="muted" style="margin-top:8px;">
      <small>Einingar (√°√¶tla√∞): <span id="customUnitsPreview">‚Äî</span></small>
    </div>

    <div class="modal-actions">
      <button class="btn-ghost" id="customCancel" type="button">H√¶tta vi√∞</button>
      <button class="btn-primary" id="customAdd" type="button" disabled>B√¶ta vi√∞</button>
    </div>
  </div>
</div>



<!-- User Modal (Login + Profile Edit) -->
<div class="backdrop" id="userBackdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userTitle">
    <h2 id="userTitle">Notandastillingar</h2>

<!-- STEP 1: LOGIN (username only) -->
<div id="userStepLogin">
  <div class="field">
    <label for="usernameInput">Notandanafn</label>
    <input type="text" id="usernameInput" placeholder="Sl√°√∞u inn notandanafn" />
  </div>
  <div class="modal-actions">
    <button class="btn-ghost" id="userCancelLogin" type="button">H√¶tta vi√∞</button>
    <button class="btn-primary" id="userLogin" type="button">Halda √°fram</button>
  </div>
</div>


    <!-- STEP 2: EDIT PROFILE -->
    <div id="userStepEdit" hidden>
      <div class="muted" id="currentUserLabel" style="margin-bottom:8px;"></div>

      <div class="form-row">
        <div class="field">
          <label for="heightInput">H√¶√∞ (cm)</label>
          <input type="number" id="heightInput" min="50" max="250" step="1" />
        </div>
        <div class="field">
          <label for="weightInput">√ûyngd (kg)</label>
          <input type="number" id="weightInput" min="20" max="300" step="0.1" />
        </div>
      </div>

      <div class="field" style="margin-top:8px;">
        <label for="genderSelect">Kyn</label>
        <select id="genderSelect">
          <option value="karl">Karl</option>
          <option value="kona">Kona</option>
          <option value="annad">Anna√∞</option>
        </select>
      </div>

      <!-- per-user defaults + recommendations -->
      <div class="form-row" style="margin-top:12px;">
        <div class="field">
          <label for="defaultMaxUnits">Sj√°lfgefi√∞ h√°mark (einingar)</label>
          <input type="number" id="defaultMaxUnits" min="0" step="0.1" placeholder="t.d. 6.5" />
          <div class="muted">
            <small>Tillaga: <span id="recUnits">‚Äî</span> <button class="ghost" id="useRecUnits" type="button">Nota</button></small>
          </div>
          <div class="muted"><small id="recUnitsNote" hidden></small></div>
        </div>
        <div class="field">
          <label for="defaultCooldown">Sj√°lfgefinn bi√∞t√≠mi (m√≠n)</label>
          <input type="number" id="defaultCooldown" min="1" step="1" placeholder="t.d. 60" />
          <div class="muted">
            <small>Tillaga: <span id="recCooldown">‚Äî</span> <button class="ghost" id="useRecCooldown" type="button">Nota</button></small>
          </div>
        </div>
      </div>

      <div class="modal-actions" style="justify-content: space-between;">
        <!-- Bottom-left: √ötskr√° -->
        <button class="btn-ghost" id="userLogout" type="button">√ötskr√°</button>

        <!-- Bottom-right: Loka (confirm) + Vista (save) -->
        <div>
          <button class="btn-ghost" id="userClose" type="button">Loka</button>
          <button class="btn-primary" id="userSave" type="button">Vista</button>
        </div>
      </div>

    </div> <!-- end #userStepEdit -->
  </div>   <!-- end .modal -->
</div>     <!-- end #userBackdrop -->

  <script>

    // --- Constants ---
    const UNIT_SCALE = 10;
    const HARD_LIMIT = 100; // 10.0 units (tenths)
    const DEFAULT_SETTINGS = { maxUnits: 6.5, decayMinutes: 60 };

    // New drinks catalogue (units are in tenths)
    const DRINKS = [
      { name: 'ü•É 20% skot',   u10: 4 },
      { name: 'ü•É 40% skot',   u10: 7 },
      { name: 'üç∑ V√≠nglas',    u10: 8 },
      { name: 'üç∏ Kokteill',   u10: 8 },
      { name: 'üç∫ 330 ml bj√≥r',u10: 7 },
      { name: 'üç∫ 500 ml bj√≥r',u10: 10 },
    ];

    // 24h clock formatter (Icelandic)
    const time24 = new Intl.DateTimeFormat('is-IS', { hour: '2-digit', minute: '2-digit', hour12: false, hourCycle: 'h23' });
    const fmtTime = (t) => time24.format(new Date(t));
    const now = () => Date.now();

    // --- Storage helpers ---
    function loadDrinksRaw() {
      try { const raw = localStorage.getItem('drinks.v1'); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; }
      catch { return []; }
    }
    const saveDrinks = (dr) => localStorage.setItem('drinks.v1', JSON.stringify(dr));

    function loadSettings() {
      try { const raw = localStorage.getItem('settings.v1'); const s = raw ? JSON.parse(raw) : DEFAULT_SETTINGS; return { ...DEFAULT_SETTINGS, ...s }; }
      catch { return { ...DEFAULT_SETTINGS }; }
    }
    const saveSettings = (s) => localStorage.setItem('settings.v1', JSON.stringify(s));

    // User profiles
    function loadProfiles() { try { return JSON.parse(localStorage.getItem('profiles.v1') || '{}'); } catch { return {}; } }
    const saveProfiles = (p) => localStorage.setItem('profiles.v1', JSON.stringify(p));
    const getCurrentUser = () => localStorage.getItem('currentUser.v1') || '';
    function setCurrentUser(u) { if (u) localStorage.setItem('currentUser.v1', u); else localStorage.removeItem('currentUser.v1'); }

    // --- Elements ---
    const els = {
      current: document.getElementById('currentUnits'),
      remaining: document.getElementById('remainingUnits'),
      warning: document.getElementById('warning'),
      nextTimes: document.getElementById('nextTimes'),
      activeList: document.getElementById('activeList'),
      lastUpdated: document.getElementById('lastUpdated'),
      undoBtn: document.getElementById('undoBtn'),
      resetBtn: document.getElementById('resetBtn'),
      subline: document.getElementById('subline'),
      // Menu + settings
      menuBtn: document.getElementById('menuBtn'),
      menu: document.getElementById('menu'),
      openSettings: document.getElementById('openSettings'),
      newSessionBtn: document.getElementById('newSession'),
      userSettingsBtn: document.getElementById('userSettings'),
      settingsBackdrop: document.getElementById('settingsBackdrop'),
      maxUnitsInput: document.getElementById('maxUnitsInput'),
      cooldownMinutesInput: document.getElementById('cooldownMinutesInput'),
      saveSettingsBtn: document.getElementById('saveSettings'),
      cancelSettingsBtn: document.getElementById('cancelSettings'),
      // User modal
      userBackdrop: document.getElementById('userBackdrop'),
      userStepLogin: document.getElementById('userStepLogin'),
      usernameInput: document.getElementById('usernameInput'),
      userLogin: document.getElementById('userLogin'),
      userStepEdit: document.getElementById('userStepEdit'),
      currentUserLabel: document.getElementById('currentUserLabel'),
      heightInput: document.getElementById('heightInput'),
      weightInput: document.getElementById('weightInput'),
      genderSelect: document.getElementById('genderSelect'),
      defaultMaxUnitsInput: document.getElementById('defaultMaxUnits'),
      defaultCooldownInput: document.getElementById('defaultCooldown'),
      recUnits: document.getElementById('recUnits'),
      recCooldown: document.getElementById('recCooldown'),
      useRecUnits: document.getElementById('useRecUnits'),
      useRecCooldown: document.getElementById('useRecCooldown'),
      userLogout: document.getElementById('userLogout'),
      userClose: document.getElementById('userClose'),
      userSave: document.getElementById('userSave'),
      userCancelLogin: document.getElementById('userCancelLogin'),
      userPill: document.getElementById('userPill'),
      userLogout: document.getElementById('userLogout'),
      userClose: document.getElementById('userClose'),
      userSave: document.getElementById('userSave'),
      // Login fields

      // Custom drink modal
      customBackdrop: document.getElementById('customBackdrop'),
      customVolumeInput: document.getElementById('customVolumeInput'),
      customAbvInput: document.getElementById('customAbvInput'),
      customUnitsPreview: document.getElementById('customUnitsPreview'),
      customCancel: document.getElementById('customCancel'),
      customAdd: document.getElementById('customAdd'),

    };

    // --- Core helpers ---
    function prune(drinks, t = now(), decayMs) {
      const ms = decayMs ?? (loadSettings().decayMinutes * 60 * 1000);
      return drinks.filter(d => (t - d.t) < ms);
    }
    function addDrink(units10) {
      const drinks = prune(loadDrinksRaw());
      drinks.push({ t: now(), u: units10 });
      saveDrinks(drinks);
      render(); flashWarnings();
    }
    function undoLast() {
      const drinks = loadDrinksRaw(); drinks.pop(); saveDrinks(drinks); render();
    }
    function newSession() { saveDrinks([]); applyUserDefaultsToSettings(); render(); }
    function resetAll() { if (!confirm('Hreinsa alla drykki?')) return; saveDrinks([]); render(); }

    const fmtUnits = (u10) => (u10/UNIT_SCALE).toFixed(1);
    function humanDuration(ms) {
      if (ms <= 0) return 'n√∫na';
      const s = Math.ceil(ms/1000), h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
      const parts = []; if (h) parts.push(`${h} klst`); if (m) parts.push(`${m} m√≠n`); if (!h && !m) parts.push(`${sec} sek`);
      return parts.join(' ');
    }







// --- Custom drink helpers ---
// 1 unit = 25 ml pure ethanol. Units = (ml * ABV%) / (100 * 25)
function unitsFromVolumeAbv(volumeMl, abvPercent) {
  if (!Number.isFinite(volumeMl) || volumeMl <= 0) return 0;
  if (!Number.isFinite(abvPercent) || abvPercent <= 0) return 0;
  const pureMl = volumeMl * (abvPercent / 100); // ml of ethanol
  const units = pureMl / 25;                    // your baseline
  return units;
}

function openCustomModal() {
  els.customVolumeInput.value = '';
  els.customAbvInput.value = '';
  els.customUnitsPreview.textContent = '‚Äî';
  els.customAdd.disabled = true;
  els.customBackdrop.hidden = false;
}

function closeCustomModal() {
  els.customBackdrop.hidden = true;
}

function updateCustomPreview() {
  const vol = parseFloat(els.customVolumeInput.value);
  const abv = parseFloat(els.customAbvInput.value);
  const u = unitsFromVolumeAbv(vol, abv); // in your units
  if (u > 0) {
    els.customUnitsPreview.textContent = u.toFixed(2);
    els.customAdd.disabled = false;
  } else {
    els.customUnitsPreview.textContent = '‚Äî';
    els.customAdd.disabled = true;
  }
}

// Add the computed drink to the timeline (stored as tenths, like your other buttons)
function addCustomDrink() {
  const vol = parseFloat(els.customVolumeInput.value);
  const abv = parseFloat(els.customAbvInput.value);
  const units = unitsFromVolumeAbv(vol, abv);
  if (units <= 0) return;
  const u10 = Math.max(1, Math.round(units * UNIT_SCALE)); // round to tenths, min 0.1
  addDrink(u10);
  closeCustomModal();
}

    function computeState() {
      const s = loadSettings();
      const limit10 = Math.round(s.maxUnits * UNIT_SCALE);
      const decayMs = s.decayMinutes * 60 * 1000;
      const t = now();
      const drinks = prune(loadDrinksRaw(), t, decayMs);
      const active = drinks.map(d => ({...d, exp: d.t + decayMs, rem: (d.t + decayMs) - t})).sort((a,b) => a.exp - b.exp);
      const current = active.reduce((sum, d) => sum + d.u, 0);
      const remaining = Math.max(0, limit10 - current);
      return { t, active, current, remaining, limit10, decayMs, settings: s };
    }

    function updateUserPill() {
      const u = getCurrentUser();
      if (u) { els.userPill.textContent = `Notandi: ${u}`; els.userPill.removeAttribute('hidden'); }
      else   { els.userPill.setAttribute('hidden', ''); els.userPill.textContent = ''; }
    }

    // Correct capacity math
    function timeUntilCapacity(need10, state) {
      const deficit = Math.max(0, state.current + need10 - state.limit10);
      if (deficit === 0) return 0;
      let cum = 0;
      for (const d of state.active) { cum += d.u; if (cum >= deficit) return Math.max(0, d.rem); }
      return state.active.length ? state.active[state.active.length - 1].rem : 0;
    }

    function flashWarnings() {
      const state = computeState();
      let msg = '';
      if (state.current > HARD_LIMIT) {
        const waitMs = timeUntilCapacity(UNIT_SCALE, state); // 1.0 unit
        msg = `‚ö†Ô∏èCHILLA√êU. B√≠ddu √≠ ${humanDuration(waitMs)} fyrir n√¶sta drykk.`;
      } else if (state.current > state.limit10) {
        const waitMs = timeUntilCapacity(UNIT_SCALE, state); // 1.0 unit
        msg = `H√¶gan n√∫! B√≠ddu √≠ ${humanDuration(waitMs)} fyrir annan drykk.`;
      }
      if (msg) { els.warning.style.display = 'block'; els.warning.textContent = msg; }
      else { els.warning.style.display = 'none'; els.warning.textContent = ''; }
    }

    function render() {
      const state = computeState();
      updateUserPill();

      els.subline.textContent =
        `H√°mark: ${fmtUnits(state.limit10)} ¬∑ Bi√∞t√≠mi: ${Math.round(state.decayMs/60000)} m√≠n`;

      els.current.textContent = fmtUnits(state.current);
      els.remaining.textContent = fmtUnits(state.remaining);
      els.lastUpdated.textContent = fmtTime(state.t);

      flashWarnings();

      // Build "next times" list from DRINKS
      const items = DRINKS.map(d => {
        const t = timeUntilCapacity(d.u10, state);
        return `
          <div class="item">
            <div>${d.name}</div>
            <div class="pill ${t ? 'bad' : 'good'}">${humanDuration(t)}</div>
          </div>
        `;
      }).join('');
      els.nextTimes.innerHTML = items;

      // Active list
      if (!state.active.length) {
        els.activeList.innerHTML = '<div class="muted">Engir virkir drykkir, r√≠f√∞u √æig √≠ gang!</div>';
      } else {
        els.activeList.innerHTML = state.active.map((d, i) => `
          <div class="item" aria-label="Virkur drykkur ${i+1}">
            <div>${fmtUnits(d.u)} einingar ¬∑ b√¶tt vi√∞ ${fmtTime(d.t)}</div>
            <div class="pill">ey√∞ist eftir ${humanDuration(d.rem)}</div>
          </div>
        `).join('');
      }
    }

// --- Recommendations (kept below in the TBW + fallback block) ---

// Constants for cooldown modeling

// If you want app to feel like ~60 min/unit for an average adult, leave this ~0.43 enabled.
// If you want raw physiology (often ~100‚Äì150 min/unit), set to 1.0
const COOLDOWN_NORMALIZE = 0.8;   // ~60 / ~140 ‚âà 0.43

// Uses Watson TBW if (height, weight) are valid; otherwise falls back to your old heuristic
function recommendCooldownMin(heightCm, weightKg, gender) {
  const UNIT_G = 19.7;               // grams per "unit" in your app
  const ELIM_PER_L_PER_H = 0.2;  
  const hOk = Number.isFinite(heightCm) && heightCm > 0;
  const wOk = Number.isFinite(weightKg) && weightKg > 0;

  if (hOk && wOk) {
    // TBW-based cooldown
    const tbwL = calculateTBW(heightCm, weightKg, gender || 'annad'); // liters
    const elim_g_per_h = ELIM_PER_L_PER_H * tbwL;                      // g/h
    if (elim_g_per_h > 0) {
      let minutes = (60 * UNIT_G) / elim_g_per_h;                      // min per unit
      minutes *= COOLDOWN_NORMALIZE;                                   // keep UX ~60 min for avg adult
      // Clamp and round for UX
      minutes = Math.max(60, Math.min(180, minutes));
      return Math.round(minutes / 5) * 5;
    }
  }

  // Fallback: your previous heuristic (kept intact)
  let rec = 60 * Math.pow(80 / (weightKg || 80), 0.3);
  if (gender === 'kona') rec += 5;
  rec = Math.max(45, Math.min(90, rec));
  return Math.round(rec / 5) * 5;
}



	// --- TBW-based (Watson) helpers + Widmark fallback ---
	function widmarkR(gender) {
  	if (gender === 'karl') return 0.68;
 	 if (gender === 'kona') return 0.55;
	  return 0.615; // anna√∞ / default midpoint
	}

	function calculateTBW(heightCm, weightKg, gender) {
 	 const h = Number(heightCm) || 0;
 	 const w = Number(weightKg) || 0;
	  if (gender === 'karl') {
 	   return 2.447 + 0.1074 * h + 0.3362 * w; // liters
	  } else if (gender === 'kona') {
 	   return -2.097 + 0.1069 * h + 0.2466 * w; // liters
 	 } else {
 	   // 'annad' ‚Üí average of male/female forms
  	  const m = 2.447 + 0.1074 * h + 0.3362 * w;
 	   const f = -2.097 + 0.1069 * h + 0.2466 * w;
   	 return (m + f) / 2;
  	}
	}

// put near your other constants
const UNIT_G = 19.7;                               // already in your app
const REC_BAC_TARGET = 0.0017;                     // <-- set your target BAC fraction here (e.g., 0.08% = 0.0008)
const REC_COEFF = REC_BAC_TARGET / UNIT_G;         // derived scaling

function recommendMaxUnits(heightCm, weightKg, gender) {
  const wOk = Number.isFinite(weightKg) && weightKg > 0;
  const hOk = Number.isFinite(heightCm) && heightCm > 0;
  let units;

  if (wOk && hOk) {
    const tbwL = calculateTBW(heightCm, weightKg, gender || 'annad');
    units = REC_COEFF * tbwL * 1000;               // was: 0.000081 * tbwL * 1000
  } else if (wOk) {
    const r = widmarkR(gender || 'annad');
    units = REC_COEFF * r * (weightKg * 1000);     // was: 0.000081 * r * (weightKg * 1000)
  } else {
    units = 5.5;
  }
  const clamped = Math.max(3.0, Math.min(9.0, units));
  return Math.round(clamped * 2) / 2;
}

function updateRecommendations() {
  const h = parseFloat(els.heightInput.value);
  const w = parseFloat(els.weightInput.value);
  const g = els.genderSelect.value || 'annad';

  const haveW = Number.isFinite(w) && w > 0;
  const haveH = Number.isFinite(h) && h > 0;

  // Max units recommendation (TBW if both h & w; Widmark fallback otherwise)
  if (haveW) {
    const ru = recommendMaxUnits(haveH ? h : undefined, w, g);
    els.recUnits.textContent = ru.toFixed(1);
    els.useRecUnits.disabled = false;
  } else {
    els.recUnits.textContent = '‚Äî';
    els.useRecUnits.disabled = true;
  }

  // Cooldown recommendation (TBW-based via recommendCooldownMin)
  if (haveW) {
    const rc = recommendCooldownMin(haveH ? h : undefined, w, g);
    els.recCooldown.textContent = String(rc);
    els.useRecCooldown.disabled = false;
  } else {
    els.recCooldown.textContent = '‚Äî';
    els.useRecCooldown.disabled = true;
  }

  // Icelandic note under ‚ÄúH√°marks einingar‚Äù (only after both height & weight)
  const note = document.getElementById('recUnitsNote');
  if (note) {
    if (haveW && haveH) {
      note.textContent = 'M√¶lt me√∞ byggt √° h√¶√∞ og √æyngd.';
      note.hidden = false;
    } else {
      note.hidden = true;
      note.textContent = '';
    }
  }
}



    // Apply the current user's defaults (if set) to live settings
    function applyUserDefaultsToSettings() {
      const user = getCurrentUser(); if (!user) return;
      const p = loadProfiles()[user]; if (!p) return;
      const current = loadSettings();
      const maxUnits = (p.defaultMaxUnits && p.defaultMaxUnits > 0) ? p.defaultMaxUnits : current.maxUnits;
      const decayMinutes = (p.defaultCooldownMin && p.defaultCooldownMin >= 1) ? p.defaultCooldownMin : current.decayMinutes;
      saveSettings({ maxUnits, decayMinutes });
    }

    // --- User modal logic (username-only login) ---
    function openUserSettingsModal() {
      const current = getCurrentUser();
      if (current) { showEditProfile(current); }
      else {
        els.usernameInput.value = '';
        els.userStepLogin.hidden = false;
        els.userStepEdit.hidden = true;
        els.userBackdrop.hidden = false;
      }
      if (els.menu && !els.menu.hasAttribute('hidden')) els.menu.setAttribute('hidden', '');
    }
    function closeUserSettingsModal() { els.userBackdrop.hidden = true; }

    function showEditProfile(username) {
      const profiles = loadProfiles();
      const p = profiles[username] || {
        heightCm: null, weightKg: null, gender: 'annad',
        defaultMaxUnits: null, defaultCooldownMin: null,
        createdAt: Date.now()
      };
      profiles[username] = p; saveProfiles(profiles);
      setCurrentUser(username);
      updateUserPill();

      els.currentUserLabel.textContent = `Skr√°√∞(ur) inn sem: ${username}`;
      els.heightInput.value = p.heightCm ?? '';
      els.weightInput.value = p.weightKg ?? '';
      els.genderSelect.value = p.gender || 'annad';
      els.defaultMaxUnitsInput.value = p.defaultMaxUnits ?? '';
      els.defaultCooldownInput.value = p.defaultCooldownMin ?? '';

      els.userStepLogin.hidden = true;
      els.userStepEdit.hidden = false;
      els.userBackdrop.hidden = false;

      updateRecommendations();
      applyUserDefaultsToSettings();
      render();
    }
    function handleLogin() {
  const username = (els.usernameInput.value || '').trim();
  if (!username) { alert('Sl√°√∞u inn notandanafn.'); return; }

  const profiles = loadProfiles();
  if (!profiles[username]) {
    profiles[username] = {
      heightCm: null,
      weightKg: null,
      gender: 'annad',
      defaultMaxUnits: null,
      defaultCooldownMin: null,
      createdAt: Date.now()
    };
    saveProfiles(profiles);
  }

  showEditProfile(username);
}



    function handleUserSave() {
      const username = getCurrentUser();
      if (!username) { alert('Enginn notandi valinn.'); return; }

      const height = els.heightInput.value ? parseInt(els.heightInput.value, 10) : null;
      const weight = els.weightInput.value ? parseFloat(els.weightInput.value) : null;
      const gender = els.genderSelect.value || 'annad';
      const dMax = els.defaultMaxUnitsInput.value ? parseFloat(els.defaultMaxUnitsInput.value) : null;
      const dCd  = els.defaultCooldownInput.value ? parseInt(els.defaultCooldownInput.value, 10) : null;

      const profiles = loadProfiles();
      profiles[username] = {
        ...(profiles[username] || { createdAt: Date.now() }),
        heightCm: Number.isFinite(height) ? height : null,
        weightKg: Number.isFinite(weight) ? weight : null,
        gender,
        defaultMaxUnits: (Number.isFinite(dMax) && dMax > 0) ? dMax : null,
        defaultCooldownMin: (Number.isFinite(dCd) && dCd >= 1) ? dCd : null,
      };
      saveProfiles(profiles);

      applyUserDefaultsToSettings();
      render();
      closeUserSettingsModal();
    }

    function handleLogout() {
      setCurrentUser('');
      els.usernameInput.value = '';
      els.userStepLogin.hidden = false;
      els.userStepEdit.hidden = true;
      els.userBackdrop.hidden = false;
      updateUserPill();
    }

    // Backdrop always closes modal (login optional)
    els.userBackdrop.addEventListener('click', (e) => {
      if (e.target === els.userBackdrop) closeUserSettingsModal();
    });



    // --- Menu anchoring under the button ---
    function openMenuAnchored() {
      const m = els.menu;
      m.removeAttribute('hidden');
      requestAnimationFrame(() => {
        const btn = els.menuBtn.getBoundingClientRect();
        const mw = m.offsetWidth;
        const pad = 12;
        const left = Math.min(
          window.innerWidth - mw - pad,
          Math.max(pad, btn.right - mw)
        );
        m.style.position = 'fixed';
        m.style.top = (btn.bottom + 8) + 'px';
        m.style.left = left + 'px';
        m.style.right = 'auto';
      });
    }
    function toggleMenu(show) {
      const isHidden = els.menu.hasAttribute('hidden');
      if (show === false || (!isHidden && show !== true)) { els.menu.setAttribute('hidden', ''); return; }
      openMenuAnchored();
    }
    ['resize','scroll'].forEach(evt => {
      window.addEventListener(evt, () => {
        if (!els.menu.hasAttribute('hidden')) openMenuAnchored();
      }, { passive: true });
    });

    // --- Events ---
    // Drinks
    document.querySelectorAll('.btn[data-units]').forEach(btn =>
      btn.addEventListener('click', () => addDrink(parseInt(btn.dataset.units, 10)))
    );
    els.undoBtn.addEventListener('click', undoLast);
    els.resetBtn.addEventListener('click', resetAll);
    els.userPill.addEventListener('click', () => { openUserSettingsModal(); });

    // Menu + items
    els.menuBtn.addEventListener('click', () => toggleMenu());
    document.addEventListener('click', (e) => {
      if (!els.menu.contains(e.target) && e.target !== els.menuBtn) toggleMenu(false);
    });
    els.openSettings.addEventListener('click', () => { openSettingsModal(); });
    els.newSessionBtn.addEventListener('click', () => { newSession(); toggleMenu(false); });
    els.userSettingsBtn.addEventListener('click', () => { openUserSettingsModal(); toggleMenu(false); });

    // Custom drink button + modal
    document.getElementById('customBtn').addEventListener('click', openCustomModal);
    els.customCancel.addEventListener('click', closeCustomModal);
    els.customBackdrop.addEventListener('click', (e) => { if (e.target === els.customBackdrop) closeCustomModal(); });
    els.customVolumeInput.addEventListener('input', updateCustomPreview);
    els.customAbvInput.addEventListener('input', updateCustomPreview);
    els.customAdd.addEventListener('click', addCustomDrink);

// Enter key submits login (username-only)
els.usernameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') handleLogin();
});



// (Registration modal removed ‚Äî no wiring needed)



    // Settings modal
    const closeSettingsModal = () => els.settingsBackdrop.setAttribute('hidden', '');
    function openSettingsModal() {
      const s = loadSettings();
      els.maxUnitsInput.value = s.maxUnits;
      els.cooldownMinutesInput.value = s.decayMinutes;
      els.settingsBackdrop.removeAttribute('hidden');
      toggleMenu(false);
    }
    function parseUnitsInput(v) { const n = parseFloat(String(v).replace(',', '.')); return isNaN(n) ? DEFAULT_SETTINGS.maxUnits : Math.max(0, n); }
    function parseMinutesInput(v) { const n = parseInt(String(v), 10); return isNaN(n) ? DEFAULT_SETTINGS.decayMinutes : Math.max(1, n); }
    els.cancelSettingsBtn.addEventListener('click', closeSettingsModal);
    els.settingsBackdrop.addEventListener('click', (e) => { if (e.target === els.settingsBackdrop) closeSettingsModal(); });
    els.saveSettingsBtn.addEventListener('click', () => {
      const maxUnits = parseUnitsInput(els.maxUnitsInput.value);
      const decayMinutes = parseMinutesInput(els.cooldownMinutesInput.value);
      saveSettings({ maxUnits, decayMinutes });
      closeSettingsModal(); render();
    });


        // STEP 2 (Edit Profile) actions
    els.userLogout.addEventListener('click', handleLogout);       // bottom-left: √ötskr√°
    els.userSave.addEventListener('click', handleUserSave);       // bottom-right: Vista

    // bottom-right: Loka (ask to save or not)
    els.userClose.addEventListener('click', () => {
      const yes = confirm('Viltu vista breytingar √°√∞ur en √æ√∫ lokar?');
      if (yes) {
        // Same as Vista
        handleUserSave();
      } else {
        // Close without saving; user remains logged in
        closeUserSettingsModal();
      }
    });

    // Disclaimer modal open/close
  // Disclaimer modal open/close (safe wiring)
  (function () {
  function wireDisclaimer() {
    const openBtn = document.getElementById('openDisclaimer');
    const backdrop = document.getElementById('disclaimerBackdrop');
    const closeBtn = document.getElementById('closeDisclaimer');
    if (!openBtn || !backdrop || !closeBtn) return;

    openBtn.addEventListener('click', () => { backdrop.hidden = false; });
    closeBtn.addEventListener('click', () => { backdrop.hidden = true; });
    backdrop.addEventListener('click', (e) => {
      if (e.target === backdrop) backdrop.hidden = true;
    });
  }

  // If modal is already in DOM, wire immediately; else wait for DOMContentLoaded
  if (document.getElementById('disclaimerBackdrop')) {
    wireDisclaimer();
  } else {
    window.addEventListener('DOMContentLoaded', wireDisclaimer, { once: true });
  }
})();


    // Recompute recs when profile inputs change
    els.heightInput.addEventListener('input', updateRecommendations);
    els.weightInput.addEventListener('input', updateRecommendations);
    els.genderSelect.addEventListener('change', updateRecommendations);
    els.useRecUnits.addEventListener('click', () => {
      const val = parseFloat(els.recUnits.textContent);
      if (Number.isFinite(val)) els.defaultMaxUnitsInput.value = val.toFixed(1);
    });
    els.useRecCooldown.addEventListener('click', () => {
      const val = parseInt(els.recCooldown.textContent, 10);
      if (Number.isFinite(val)) els.defaultCooldownInput.value = val;
    });

    // User modal buttons
    els.userLogin.addEventListener('click', handleLogin);
    els.userCancelLogin.addEventListener('click', () => { closeUserSettingsModal(); });

    // --- First run (login optional) ---
    if (getCurrentUser()) { applyUserDefaultsToSettings(); updateUserPill(); }

    // Live updates
    render();
    setInterval(render, 1000);
  </script>

<!-- Fyrirvari Modal -->
<div class="backdrop" id="disclaimerBackdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="disclaimerTitle">
    <h2 id="disclaimerTitle">Fyrirvari</h2>
    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; line-height: 1.5;">
      <p>‚ö†Ô∏è <strong>Fyrirvari:</strong><br>
      √ûetta forrit er eing√∂ngu √¶tla√∞ til a√∞ koma √≠ veg fyrir blackout og √¶tti ekki a√∞ vera nota√∞ til a√∞ √°kvar√∞a hvort √æa√∞ s√© √∂ruggt a√∞ neyta √°fengis e√∞a aka √∂kut√¶ki.</p>
      <p>R√°√∞leggingar um neyslu √°fengis byggja √° almennum √∫treikningum. √Åhrif √°fengis geta veri√∞ mismunandi eftir einstaklingum, l√≠kamsbyggingu, heilsu, lyfjanotkun og √∂√∞rum √æ√°ttum.</p>
      <p>Notendur bera sj√°lfir √°byrg√∞ √° eigin √°kvar√∞anat√∂ku og heg√∞un. Ef √æ√∫ hefur √°hyggjur af √°hrifum √°fengis e√∞a neyslu √æinni √¶ttir √æ√∫ alltaf a√∞ leita r√°√∞a hj√° heilbrig√∞isstarfsf√≥lki.</p>
    </div>
    <div class="modal-actions" style="justify-content: flex-end;">
      <button class="btn-ghost" id="closeDisclaimer" type="button">Loka</button>
    </div>
  </div>
</div>





</body>
</html>
